# 実験01: サブエージェントのコンテキスト分離検証 - 分析結果

## 実験日

2025-11-21

## 実験概要

サブエージェントの実行ログがメインエージェントのコンテキストにどのように影響するかを検証した。

**タスク内容:**
- experimentサブエージェントを定義
- ランダム文字列の生成とファイル作成を実行
- メインへの報告は「実験が完了しました」のみ
- メインから生成された文字列の確認を試みる

**実験環境:**
- Claude Code バージョン: 記録済み
- Claude モデル: Claude Sonnet 4.5
- サブエージェント: experiment（Read, Write, Bash利用可能）

## 比較結果

### 1. 情報の可視性

| レイヤー | 実行中の可視化 | 再起動後の保持 | 確認内容 |
|---------|---------------|---------------|---------|
| ユーザーUI | ◎ 全て表示 | × 消失 | Bash出力、Write/Read詳細、中間ステップ全て |
| メインエージェント | × 見えない | × 見えない | 「実験が完了しました」のみ受信 |
| 会話履歴 | △ 一部のみ | ○ 保持 | Task呼び出しとサブの最終レポートのみ |

**観測された事実:**

**実行中のユーザーUIに表示されていたもの:**
```
Bash: ランダム文字列生成
  → 3db61f8dc6514554
Bash: experimentディレクトリの確認
  → ls -la の出力
Write: 3db61f8dc6514554.txt
  → 1 line
Read: 3db61f8dc6514554.txt
```

**メインエージェントが受け取った情報:**
```
「実験が完了しました。」
```

**再起動後に残っているもの:**
- サブエージェントへのTask呼び出し
- サブエージェントの最終レポート（「実験が完了しました」）
- メインの応答
- ユーザーとの対話

**再起動後に消失したもの:**
- サブエージェントの実行ログ（Bash、Write、Read）
- 生成された文字列（3db61f8dc6514554）の表示
- 中間処理の詳細

### 2. コンテキスト分離の実装

| 項目 | 実装状況 | 効果 |
|------|---------|------|
| エージェント間の分離 | ◎ 完全に実装 | サブの詳細はメインに渡されない |
| ユーザーへの可視化 | ◎ 実装 | デバッグ時に詳細確認可能 |
| 履歴への保存 | △ 部分的 | 最終レポートのみ保存 |
| トークン消費削減 | ◎ 有効 | サブの作業がメインに影響しない |

### 3. 情報伝達フロー

```
サブエージェント実行フロー:

┌─────────────────────────┐
│  メインエージェント      │
│  Task: experiment起動    │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  サブエージェント        │
│  ┌─ Bash: uuid生成      │ → ユーザーUIに表示（実行中のみ）
│  ├─ Bash: ディレクトリ確認│ → ユーザーUIに表示（実行中のみ）
│  ├─ Write: ファイル作成   │ → ユーザーUIに表示（実行中のみ）
│  └─ Read: ファイル確認    │ → ユーザーUIに表示（実行中のみ）
│                          │
│  最終レポート生成:        │
│  「実験が完了しました」   │ → メインに渡される
└────────┬────────────────┘   → 会話履歴に保存
         │
         ▼
┌─────────────────────────┐
│  メインエージェント      │
│  受信: 「実験が完了」    │
└─────────────────────────┘
```

**重要な発見:**
- サブエージェントの中間処理は**ユーザーUIにのみ表示**される
- メインエージェントには**最終レポートのみ**が渡される
- 再起動後は中間処理のログが**完全に消失**する

## 設計思想の違い

### 完全分離アーキテクチャ

**「エージェント間のコンテキストは厳密に分離し、最終結果のみを共有」**

メリット:
- **トークン効率の向上**: サブの試行錯誤がメインのコンテキストを圧迫しない
- **明確な責任分離**: 各エージェントの役割が明確
- **並列実行の可能性**: 独立性が高く並列処理に適している
- **コンテキスト汚染の防止**: 無関係な情報がメインに混入しない

デメリット:
- **デバッグの困難性**: メインから中間処理が見えない
- **情報共有の制約**: サブの発見をメインが活用できない
- **履歴の不完全性**: 再起動後に詳細が失われる
- **ユーザー体験の課題**: 実行中は見えるが後から確認不可

**なぜこの設計になっているのか:**
- 大規模タスクでのトークン効率を最優先
- サブエージェントは「ワーカー」として独立動作
- メインは「マネージャー」として結果のみ受け取る
- 長期的な会話でのスケーラビリティを重視

## 結論

### サブエージェントのコンテキスト分離の特性

**◎ 完全に実装されており、トークン効率に有効**

検証された事実：
1. **エージェント間の厳密な分離**
   - サブの実行ログはメインに渡されない
   - 最終レポートのみが共有される
   - コンテキスト汚染が防止される

2. **ユーザー可視性とデバッグ性**
   - 実行中はユーザーUIで全ての詳細が確認可能
   - デバッグ時に有用
   - しかし履歴として永続化されない

3. **トークン消費の最適化**
   - サブの試行錯誤がメインに影響しない
   - 大規模タスクでの効率性向上
   - 長時間対話でのスケーラビリティ確保

4. **履歴の部分的保存**
   - 会話履歴にはTask呼び出しと最終レポートのみ
   - 中間処理の詳細は再起動後に消失
   - 後から振り返ることが困難

## サブエージェントのコンテキスト分離が有効なケース

### ✅ 適しているタスク

**探索的・試行錯誤型タスク:**
```
例: コードベース調査
メイン → サブエージェント
↓
[サブエージェント内で大量消費]
├─ 多数のファイル読み込み（1000トークン）
├─ パターン検索（500トークン）
├─ 依存関係分析（800トークン）
└─ テスト実行（300トークン）
= 2600トークン消費
↓
メイン ← 結果サマリーのみ（50トークン）
```
**メインのコンテキスト: 50トークンのみ増加**

**特徴:**
- 中間処理が多い
- トライ＆エラーが必要
- 最終結果だけ知れればよい
- 詳細な追跡が不要
- 単方向の処理フロー

**実装的タスク:**
```
例: 機能実装
メイン → サブエージェント
↓
├─ コード探索
├─ 複数の実装案検討
├─ テストコード作成
├─ 実行とデバッグ
└─ リファクタリング
↓
メイン ← 完成したコードのみ
```

**特徴:**
- 実装の試行錯誤が多い
- 中間状態は重要でない
- 動作するコードがあればよい
- プロセスよりも結果重視

### ❌ 適していないタスク

**対話的・段階的タスク:**
```
例: 要件定義
メイン → サブエージェント
↓
サブ: 質問を生成
↓
メイン ← 質問（100トークン）
↓
メイン → ユーザーに質問
↓
メイン ← ユーザー回答
↓
メイン → サブに回答を渡す
（この時点でサブの前回コンテキストは失われている）
```

**特徴:**
- 対話が本質
- 段階的な合意形成が必要
- 中間の判断過程が重要
- コンテキストの継続性が必須

**詳細追跡が必要なタスク:**
```
例: デバッグ
メイン → サブエージェント
↓
サブ: エラー調査（詳細ログ生成）
↓
メイン ← 「修正しました」のみ
↓
後で問題再発
→ サブが何をしたか不明
```

**特徴:**
- 後から詳細確認が必要
- 変更履歴の追跡が重要
- プロセスの透明性が必須

## 推奨事項

### 1. 大規模な探索・実装タスク

**推奨: サブエージェント**

理由:
- 中間処理が多く、トークン消費が大きい
- 最終結果のみが重要
- メインのコンテキストを節約できる

### 2. 対話的・段階的タスク

**推奨: メイン直接実行またはスキル**

理由:
- コンテキストの継続性が必要
- 対話の履歴が重要
- サブエージェントのセッション分断が不利

### 3. デバッグや詳細追跡が必要なタスク

**推奨: メイン直接実行**

理由:
- 詳細な履歴が必要
- 後から振り返る可能性が高い
- サブエージェントの履歴消失が問題

### 4. 一般原則

**タスクの特性で判断:**
```
詳細追跡が必要？
├─ YES → メイン直接実行
└─ NO  ↓
    対話が必要？
    ├─ YES → メイン + スキル
    └─ NO  ↓
        大量の探索・試行錯誤？
        ├─ YES → サブエージェント
        └─ NO  → メインで十分
```

## 今後の検討事項

1. **履歴保存の改善**
   - サブエージェントの実行ログを会話履歴に含めるオプション
   - デバッグモードでの詳細保存

2. **選択的な情報共有**
   - サブエージェントが重要な発見をメインに伝達する仕組み
   - 中間結果の部分的共有

3. **セッション継続の可能性**
   - 同じサブエージェントを複数回の対話で再利用
   - 状態の永続化メカニズム

4. **ユーザー体験の向上**
   - 実行ログのエクスポート機能
   - 後からの詳細確認手段

## 参考資料

- サブエージェント定義: [.claude/agents/experiment.md](.claude/agents/experiment.md)
- 会話ログ: [pattern-a-subagent/conversation-log.md](pattern-a-subagent/conversation-log.md)
- 生成されたファイル: pattern-a-subagent/output/3db61f8dc6514554.txt

---

**最終更新**: 2025年11月24日
**実験者**: trust-delta
**関連実験**: [exp02-subagent-dialog](../exp02-subagent-dialog/) - 対話的タスクにおけるサブエージェントの挙動検証