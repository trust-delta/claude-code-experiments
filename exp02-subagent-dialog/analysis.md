# 実験02: 対話的タスクにおけるサブエージェントの挙動検証 - 分析結果

## 実験日

2025-11-29（再実験）

## 実験概要

TODOアプリの「優先度自動調整機能」の要件定義を、2つのパターンで実施し比較した。

**タスク内容:**
- 機能の目的確認
- 自動調整の基準設定
- 調整タイミングの決定
- ユーザー制御の仕様化
- 完成後の修正（「手動調整機能も残したい」）

**実験環境:**
- Claude Code バージョン: 記録済み
- Claude モデル: claude-opus-4-5-20251101

**比較対象:**
- パターンA: サブエージェント（requirements-definer）
- パターンB: カスタムスラッシュコマンド（/requirements-helper）

## 比較結果

### 1. 対話フローの効率性

| 項目 | パターンA（サブエージェント） | パターンB（コマンド） |
|------|----------------------------|---------------------|
| 対話の自然さ | △ メイン経由で仲介 | ◎ 直接的な対話 |
| 質問→回答の流れ | メイン → サブ → メイン → ユーザー | メイン ←→ ユーザー |
| セッション継続性 | × 各Task呼び出しで独立 | ◎ 会話全体で継続 |
| 中継コスト | 高い（メインが仲介） | なし |

**実際の対話フロー:**

パターンA:
```
[ユーザー] → [メイン] → [サブエージェント]
                ↑              ↓
                └── 質問を中継 ←┘
                       ↓
               [ユーザー回答]
                       ↓
               [メイン] → [新しいサブエージェント]
               （前回のコンテキストを再構築）
```

パターンB:
```
[ユーザー] ←→ [メイン（コマンド展開）]
       直接的なQ&A
```

### 2. コンテキスト管理

| 項目 | パターンA | パターンB |
|------|-----------|-----------|
| 状態保持の方法 | ファイルベース | 会話コンテキスト |
| セッション分断 | ◯ 毎回発生 | × 発生しない |
| 判断理由の保持 | △ ファイルに記載された内容のみ | ◎ 会話履歴全体 |
| 暗黙知の保持 | × 失われる | ◎ 保持される |

**状態保持の仕組み:**

**パターンA（サブエージェント）:**
```
メイン経由でサブエージェントを呼び出し
↓
サブエージェントが質問を生成
↓
メインがユーザーに質問を中継
↓
ユーザーが回答
↓
メインが回答を新しいサブエージェントに渡す
↓
（前回のコンテキストは失われている）
↓
ファイルを読み込んで状態を復元
```

**パターンB（コマンド）:**
```
メインがコマンドプロンプトを展開
↓
メイン会話内で直接対話
↓
すべての対話履歴を保持
↓
判断過程も暗黙知も維持
```

### 3. 成果物の品質

| 項目 | パターンA | パターンB |
|------|-----------|-----------|
| 文書量 | **614行（過剰）** | 61行（適切） |
| 出力先 | ❌ 指定外の場所 | ✅ 指示通り |
| 詳細度 | 過剰・指示外の項目も含む | シンプル・必要十分 |
| 優先度レベル | 3段階 | 4段階 |
| 質問の回数 | 5回 | 8回（追加質問含む） |

**成果物の性質:**

**パターンA（問題点が顕著）:**
- **614行**の過剰に詳細な要件定義書
- **指定したディレクトリに作成されない**（pattern-a-subagent/output/ → output/）
- サブエージェント定義では示されていない項目まで網羅
- 手動調整機能の詳細、変更履歴機能、確認ダイアログなど過剰な機能を追加
- シンプルな要件定義の依頼に対して過剰な成果物

**パターンB:**
- **61行**のシンプルで必要十分な要件定義書
- **指示通りの場所**（pattern-b-command/output/）に作成
- ユーザーの回答に基づいた適切な分量
- 実装者が着手できるレベルの情報量

### 4. 修正時の柔軟性

| 項目 | パターンA | パターンB |
|------|-----------|-----------|
| 修正依頼時の対応 | ファイルを読み込んで修正 | 会話の流れで自然に対応 |
| 追加質問 | 1つの選択肢 | 3つの詳細確認質問 |
| 修正の精度 | 必要最低限 | 詳細な確認後に反映 |

**修正時の挙動の違い:**

**パターンA:**
```
「手動機能を残したい」
↓
即座に選択肢を提示（a/b/c）
↓
選択後すぐに要件定義書を更新
```

**パターンB:**
```
「手動機能を残したい」
↓
3つの詳細確認質問
├─ 自動調整復帰は必要？
├─ 調整範囲は？
└─ ハイブリッドは必要？
↓
回答に基づいて詳細に反映
```

### 5. コンテキスト消費

**測定結果（パターンA実験終了時）:**
```
パターンA（サブエージェント）：
Tokens: 128.0k / 200.0k (64%)
Free space: 72.0k (36%)
```

**重要な発見:**
- 中継コストによりコンテキスト消費が増加
- 対話的タスクではサブエージェントの「独立コンテキスト」のメリットが活かせない

## 設計思想の違い

### サブエージェントの設計思想
**「独立したエキスパートとして一度で完璧な成果物を」**

メリット:
- 探索的タスクでのトークン効率
- 明確な責任分離
- 並列実行の可能性

デメリット:
- 対話的タスクでは中継コストが発生
- セッション分断により暗黙知が失われる
- 状態管理がファイルベースになる
- **指示への追従性が低い**（出力先、分量など）
- **過剰品質の傾向**（一度で完結させようとする）

**なぜ対話的タスクに不向きか:**
- ステートレスな設計との相性が悪い
- 毎回コンテキストを再構築する必要がある
- 中継によりトークン消費が増加
- **独立性ゆえに細かな制御が効きにくい**
- **「一度で完結」志向が過剰な成果物を生む**

### カスタムコマンドの設計思想
**「対話のパートナーとして柔軟に対応」**

メリット:
- 自然な対話フロー
- 会話コンテキストの維持
- 追加確認が容易

デメリット:
- メインのコンテキストを消費
- 探索的タスクには非効率な場合も

**なぜ対話的タスクに適しているか:**
- メイン会話内で完結
- 対話履歴がそのまま保持される
- 段階的な詳細化が自然

## 結論

### 対話的タスク（要件定義）におけるサブエージェントの適性

**❌ サブエージェントは対話的タスクに不向き**

理由：
1. **中継コストの発生**
   - メインが仲介役になる
   - 対話のたびにコンテキスト再構築
   - トークン消費が増加

2. **セッション分断**
   - 各Task呼び出しで独立
   - 判断過程や暗黙知が失われる
   - ファイルに書かれていない情報は保持されない

3. **指示への追従性の問題**
   - 指定したディレクトリに成果物が作成されない
   - サブエージェント定義にない項目まで過剰に追加
   - 独立性ゆえにメインからの細かな制御が効きにくい

4. **成果物の過剰性**
   - 614行もの過剰に詳細な成果物
   - シンプルな依頼に対して不釣り合いな出力
   - 「一度で完結させよう」とする傾向が過剰品質を生む

5. **メイン自身の評価**
   - サブエージェント経由の実験で「対話的タスクには不向き」と結論
   - 探索・分析タスク向きとの認識

### カスタムコマンドが適している理由

**◎ カスタムコマンドは対話的タスクに最適**

理由：
1. **自然な対話フロー**
   - 直接的なQ&A
   - 中継なしで効率的

2. **コンテキストの維持**
   - 会話履歴がそのまま保持
   - 判断過程・暗黙知も維持

3. **指示への追従性**
   - 指定したディレクトリに成果物を作成
   - ユーザーの要求に沿った適切な分量

4. **成果物の適切性**
   - 61行のシンプルで必要十分な成果物
   - 過剰でも不足でもない適切な品質
   - 実装者がすぐに着手できるレベル

## 推奨事項

### 1. 要件定義・仕様書作成

**推奨: カスタムスラッシュコマンド**

理由:
- 対話的に詳細化できる
- ユーザーの意思決定を尊重
- 段階的な合意形成が可能

### 2. コードベース探索・分析

**推奨: サブエージェント**

理由:
- 探索的作業が多い
- 途中経過より成果物が重要
- コンテキスト節約効果あり

### 3. 一般原則

**対話的タスクかどうかで判断:**
```
対話が必要？
├─ YES → カスタムコマンド or メイン直接
└─ NO  → サブエージェント検討
    ↓
    探索的作業？
    ├─ YES → サブエージェント
    └─ NO  → メインで十分
```

## 今後の検討事項

1. **サブエージェントの改善可能性**
   - セッション継続機能の追加
   - 会話履歴の自動保存・復元

2. **ハイブリッドアプローチ**
   - メインで要件定義
   - サブエージェントで実装
   - 両者の利点を組み合わせる

3. **他のタスクでの検証**
   - コードレビュー
   - デバッグ
   - リファクタリング

## 参考資料

- パターンA会話ログ: [pattern-a-subagent/conversation-log.md](pattern-a-subagent/conversation-log.md)
- パターンB会話ログ: [pattern-b-command/conversation-log.md](pattern-b-command/conversation-log.md)
- パターンA成果物: [output/requirements-priority-auto-adjustment.md](output/requirements-priority-auto-adjustment.md)（指定外の場所に作成）
- パターンB成果物: [pattern-b-command/output/priority-auto-adjustment-requirements.md](pattern-b-command/output/priority-auto-adjustment-requirements.md)

---

**最終更新**: 2025年11月29日 02:22 JST
**実験者**: trust-delta
